# Руководство по миграции Docker изменений на продакшен

## Что было изменено

### 1. Dockerfile.prod
- **Обновлен до многоэтапной сборки (multi-stage build)**
- **Улучшена безопасность** - использование non-root пользователя с правильными UID/GID
- **Оптимизирована сборка фронтенда** - более эффективная установка и очистка Node.js зависимостей
- **Добавлена предкомпиляция bootsnap** для ускорения запуска приложения
- **Улучшена очистка промежуточных файлов** для уменьшения размера образа

### 2. docker-compose.prod.yml - КРИТИЧЕСКИЕ ИЗМЕНЕНИЯ
- ❌ **Удален Redis** - больше не используется
- ❌ **Убран Sidekiq** → ✅ **Добавлен Delayed Job**
- **Обновлены переменные окружения** - убран `REDIS_URL`, добавлены `TELEGRAM_BOT_TOKEN`, `TZ`
- **Добавлена переменная окружения `BUNDLE_PATH`** для корректной работы с новой структурой
- **Обновлена команда запуска** для использования `./bin/rails` вместо `bundle exec rails`
- **Убраны зависимости от Redis** во всех сервисах

### 3. Другие файлы
- **Gemfile** - удален Redis gem (Action Cable использует PostgreSQL)
- **Health Check** - заменена проверка Redis на Delayed Job
- **Скрипты деплоя** - убраны ссылки на Redis
- **Makefile** - обновлены команды запуска

## Преимущества новой структуры

1. **Меньший размер финального образа** - промежуточные файлы сборки не попадают в финальный образа
2. **Лучшая безопасность** - приложение работает под non-root пользователем
3. **Быстрее запуск** - предкомпилированный bootsnap
4. **Более современная структура** - использование современного синтаксиса Docker
5. **Упрощенная архитектура** - отказ от Redis упрощает развертывание и обслуживание
6. **Меньше зависимостей** - один контейнер меньше (Redis), меньше точек отказа
7. **Лучшая производительность задач** - Delayed Job с PostgreSQL работает стабильнее

## Инструкции по развертыванию

### 1. Остановите текущие контейнеры
```bash
docker-compose -f docker-compose.prod.yml down
```

### 2. Пересоберите образы с новой структурой
```bash
docker-compose -f docker-compose.prod.yml build --no-cache
```

### 3. Запустите обновленные контейнеры
```bash
docker-compose -f docker-compose.prod.yml up -d
```

### 4. Проверьте статус
```bash
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs web
```

## Важные замечания

- **Обязательно пересоберите образы** с флагом `--no-cache` для применения всех изменений
- **Проверьте логи** после запуска для убеждения в корректной работе
- **Новая структура совместима** со всеми существующими переменными окружения
- **Бэкап данных** рекомендуется сделать перед обновлением

## Откат изменений (если необходимо)

Если что-то пойдет не так, можно откатиться к предыдущей версии:

```bash
git checkout HEAD~1 -- Dockerfile.prod docker-compose.prod.yml
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d
```

## Проверка работоспособности

После развертывания проверьте:

1. **Приложение доступно** по http://your-domain.com
2. **Delayed Job worker работает** корректно  
3. **База данных** подключается без ошибок
4. **Frontend собирается и отдается** правильно
5. **Health Check** показывает статус `delayed_job: connected`

## Мониторинг

Следите за:
- Размером образов: `docker images`
- Использованием ресурсов: `docker stats`
- Логами приложения: `docker-compose -f docker-compose.prod.yml logs -f web`
- Логами Delayed Job: `docker-compose -f docker-compose.prod.yml logs -f delayed_job`
- Статусом задач: проверяйте таблицу `delayed_jobs` в базе данных 