# –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Delayed Job: –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

## üéØ **–ü–æ—á–µ–º—É Delayed Job –ª—É—á—à–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è:**

### ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å Sidekiq:**
- **Polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥** - –∑–∞–¥–∞—á–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—á–∫–∞–º–∏
- **Concurrency –ø—Ä–æ–±–ª–µ–º—ã** - –Ω–µ—Å–∫–æ–ª—å–∫–æ worker'–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ 
- **Redis lag** - –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ —Å–µ—Ç–∏ –º–µ–∂–¥—É Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
- **–°–ª–æ–∂–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis
- **–ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (Redis, —Å–µ—Ç—å)

### ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Delayed Job:**
- **–¢–æ—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –≤–º–µ—Å—Ç–æ 5
- **–°—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω worker = –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤ PostgreSQL, –ª–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –º–µ–Ω—å—à–µ –¥–≤–∏–∂—É—â–∏—Ö—Å—è —á–∞—Å—Ç–µ–π, –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–æ–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–µ —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üîß **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- ‚ùå `config/initializers/sidekiq.rb` ‚Üí ‚úÖ `config/initializers/delayed_job.rb`
- ‚ùå `config/sidekiq.yml` ‚Üí ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ initializer'–µ
- ‚úÖ `sleep_delay = 1` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

### 2. Jobs:
- ‚ùå `queue_as :bot_sequential` ‚Üí ‚úÖ –£–±—Ä–∞–Ω–æ (–Ω–µ –Ω—É–∂–Ω–æ)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ callbacks
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 3. Docker:
- ‚ùå Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Üí ‚úÖ –£–¥–∞–ª–µ–Ω 
- ‚ùå 4+ Sidekiq –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Üí ‚úÖ 2 Delayed Job worker'–∞
- ‚úÖ –ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤, –ø—Ä–æ—â–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
# –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–µ–π
docker-compose exec web bundle exec rake queue:status

# –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
docker-compose exec web bundle exec rake queue:delayed

# –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ
docker-compose exec web bundle exec rake queue:clear_failed

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ
docker-compose exec web bundle exec rake queue:retry_failed
```

## üöÄ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

### 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Å—Ç–µ–º—É:
```bash
docker-compose down
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
bundle install
```

### 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã:
```bash
docker-compose build --no-cache
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É:
```bash
docker-compose up -d
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:
```bash
docker-compose exec web bundle exec rake queue:status
```

## üìä **–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. **–¢–æ—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏** - –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è `run_at`
2. **–ù–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
3. **–ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞** - –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤–∏–¥–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `delayed_jobs`
4. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - –º–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–µ–Ω—å—à–µ overhead, –ø—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î

## üîç **–û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º:**

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
```sql
-- –í—Å–µ –∑–∞–¥–∞—á–∏
SELECT id, handler, run_at, attempts, locked_at FROM delayed_jobs;

-- –¢–æ–ª—å–∫–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
SELECT id, handler, run_at FROM delayed_jobs WHERE run_at > NOW();

-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–¥–∞—á–∏
SELECT id, handler, attempts, last_error FROM delayed_jobs WHERE attempts > 0;
```

### –õ–æ–≥–∏ worker'–æ–≤:
```bash
# –û—Å–Ω–æ–≤–Ω–æ–π worker
docker-compose logs -f delayed_job

# Bot worker
docker-compose logs -f delayed_job_bots
```

## üí° **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ `priority` –ø–æ–ª–µ
- **Retry –ª–æ–≥–∏–∫–∞** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `max_attempts`
- **–£—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ jobs
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ gem `delayed_job_web` 