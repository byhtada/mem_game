<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote WebSocket Tester</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #000; color: #0f0; padding: 15px; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; margin-top: 20px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .vote-buttons { margin: 10px 0; }
        .vote-buttons button { background: #dc3545; }
        .vote-buttons button:hover { background: #c82333; }
        .mems-display { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .mem-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó≥Ô∏è Vote WebSocket Tester</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VoteChannel –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</p>
        
        <div class="input-group">
            <label for="userId">User ID:</label>
            <input type="number" id="userId" placeholder="–í–≤–µ–¥–∏—Ç–µ User ID" value="">
        </div>
        
        <div class="input-group">
            <label for="gameId">Game ID:</label>
            <input type="number" id="gameId" placeholder="–í–≤–µ–¥–∏—Ç–µ Game ID" value="">
        </div>
        
        <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VoteChannel</button>
        <button id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        
        <div id="status" class="status disconnected">
            –°—Ç–∞—Ç—É—Å: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
        </div>
        
        <div class="vote-buttons">
            <h3>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</h3>
            <button id="voteBtn" disabled>–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –º–µ–º</button>
            <button id="updateVoteBtn" disabled>–û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</button>
        </div>
        
        <div class="mems-display" id="memsDisplay" style="display: none;">
            <h3>–ú–µ–º—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:</h3>
            <div id="memsList"></div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script src="js/consumer.js"></script>
    <script>
        let voteSubscription = null;
        let actionCableConsumer = new ActionCableConsumer();
        
        const userIdInput = document.getElementById('userId');
        const gameIdInput = document.getElementById('gameId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const voteBtn = document.getElementById('voteBtn');
        const updateVoteBtn = document.getElementById('updateVoteBtn');
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        const memsDisplay = document.getElementById('memsDisplay');
        const memsList = document.getElementById('memsList');
        
        let currentRoundId = null;
        let currentMems = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(isConnected, message) {
            status.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
            status.textContent = `–°—Ç–∞—Ç—É—Å: ${message}`;
            
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            voteBtn.disabled = !isConnected || !currentRoundId;
            updateVoteBtn.disabled = !isConnected;
        }
        
        function displayMems(mems) {
            if (!mems || mems.length === 0) {
                memsDisplay.style.display = 'none';
                return;
            }
            
            currentMems = mems;
            memsDisplay.style.display = 'block';
            
            memsList.innerHTML = '';
            mems.forEach((mem, index) => {
                const memDiv = document.createElement('div');
                memDiv.className = 'mem-item';
                memDiv.innerHTML = `
                    <strong>${mem.name}</strong> (by ${mem.user_name || 'Unknown'})
                    <br>–ì–æ–ª–æ—Å–æ–≤: <strong>${mem.votes}</strong>
                    <br>User ID: ${mem.user_id}, User Num: ${mem.user_num}
                `;
                memsList.appendChild(memDiv);
            });
        }
        
        connectBtn.addEventListener('click', () => {
            const userId = userIdInput.value;
            const gameId = gameIdInput.value;
            
            if (!userId || !gameId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ User ID –∏ Game ID');
                return;
            }
            
            addLog('üîó Attempting to connect to VoteChannel...');
            addLog(`üîó User ID: ${userId}, Game ID: ${gameId}`);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Action Cable
            actionCableConsumer.connect('/cable', { user_id: userId });
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ VoteChannel
            voteSubscription = actionCableConsumer.subscribe('VoteChannel', {
                game_id: gameId
            });
            
            voteSubscription.connected = () => {
                addLog('‚úÖ Connected to VoteChannel');
                updateStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–∞–Ω–∞–ª—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
            };
            
            voteSubscription.disconnected = () => {
                addLog('‚ùå Disconnected from VoteChannel');
                updateStatus(false, '–û—Ç–∫–ª—é—á–µ–Ω –æ—Ç –∫–∞–Ω–∞–ª–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
                voteSubscription = null;
                currentRoundId = null;
                displayMems([]);
            };
            
            voteSubscription.received = (data) => {
                addLog('üì® Vote update received:');
                addLog(`   Vote finish: ${data.vote_finish}`);
                addLog(`   Vote progress: ${data.vote_progress_wait}%`);
                addLog(`   Finish game: ${data.finish_game}`);
                addLog(`   Mems count: ${data.mems ? data.mems.length : 0}`);
                addLog(`   Users count: ${data.users ? data.users.length : 0}`);
                
                if (data.round) {
                    currentRoundId = data.round.id;
                    addLog(`   Round ID: ${data.round.id}, State: ${data.round.state}`);
                }
                
                if (data.mems && data.mems.length > 0) {
                    addLog('   Mems:');
                    data.mems.forEach((mem, index) => {
                        addLog(`     ${index + 1}. ${mem.mem} (by ${mem.name}) - Votes: ${mem.votes}`);
                    });
                    displayMems(data.mems);
                }
                
                if (data.vote_finish) {
                    addLog('üèÅ Voting finished!');
                    if (data.finish_game) {
                        addLog('üéÆ Game finished!');
                    }
                }
                
                voteBtn.disabled = !voteSubscription || !currentRoundId || data.vote_finish;
                
                addLog(`   Full data: ${JSON.stringify(data, null, 2)}`);
            };
            
            updateStatus(false, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
        });
        
        disconnectBtn.addEventListener('click', () => {
            addLog('üîå Disconnecting from VoteChannel...');
            
            if (voteSubscription) {
                voteSubscription.unsubscribe();
                voteSubscription = null;
            }
            
            actionCableConsumer.disconnect();
            updateStatus(false, '–û—Ç–∫–ª—é—á–µ–Ω');
            currentRoundId = null;
            displayMems([]);
        });
        
        voteBtn.addEventListener('click', () => {
            if (!currentRoundId || currentMems.length === 0) {
                addLog('‚ùå No round ID or mems available for voting');
                return;
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –º–µ–º –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
            const randomMem = currentMems[Math.floor(Math.random() * currentMems.length)];
            
            addLog(`üì§ Voting for mem: ${randomMem.mem} (user_num: ${randomMem.user_num})`);
            
            fetch('/vote_for_mem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    round_id: currentRoundId,
                    user_num: randomMem.user_num
                })
            })
            .then(response => response.json())
            .then(data => {
                addLog('‚úÖ Vote submitted successfully');
                addLog('üì° Waiting for WebSocket broadcast...');
            })
            .catch(error => {
                addLog(`‚ùå Error submitting vote: ${error}`);
            });
        });
        
        updateVoteBtn.addEventListener('click', () => {
            const gameId = gameIdInput.value;
            
            addLog('üîÑ Requesting vote update via HTTP...');
            
            fetch('/get_vote_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    game_id: gameId
                })
            })
            .then(response => response.json())
            .then(data => {
                addLog('üìä HTTP vote update received:');
                addLog(`   Vote finish: ${data.vote_finish}`);
                addLog(`   Vote progress: ${data.vote_progress_wait}%`);
                addLog(`   Finish game: ${data.finish_game}`);
                addLog(`   Data: ${JSON.stringify(data, null, 2)}`);
            })
            .catch(error => {
                addLog(`‚ùå Error getting vote update: ${error}`);
            });
        });
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('user_id')) {
            userIdInput.value = urlParams.get('user_id');
        }
        if (urlParams.get('game_id')) {
            gameIdInput.value = urlParams.get('game_id');
        }
        
        addLog('üîß Vote WebSocket Tester initialized');
        addLog('üìù Enter User ID and Game ID, then click Connect');
        addLog('üí° Tip: Run test_vote_websocket.rb to create test data');
    </script>
</body>
</html> 