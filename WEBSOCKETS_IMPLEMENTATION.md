# üîå WebSocket —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–≥—Ä—ã

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü–µ—Ä–µ–¥–µ–ª–∞–Ω –º–µ—Ç–æ–¥ `get_update_game_ready` —Å polling –Ω–∞ –≤–µ–±-—Å–æ–∫–µ—Ç—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Action Cable**.

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ë—ç–∫–µ–Ω–¥ (Rails)

1. **GameChannel** (`app/channels/game_channel.rb`)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ

2. **Connection** (`app/channels/application_cable/connection.rb`)
   - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `user_id` –ø–∞—Ä–∞–º–µ—Ç—Ä
   - –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è Action Cable

3. **Game Model** (`app/models/game.rb`)
   - –ú–µ—Ç–æ–¥ `broadcast_game_update()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ broadcasting –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
   - Broadcasting –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–æ–≤

4. **–ú–∞—Ä—à—Ä—É—Ç—ã** (`config/routes.rb`)
   - –î–æ–±–∞–≤–ª–µ–Ω endpoint `/cable` –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ (JavaScript)

1. **Action Cable Consumer** (`memgame_web/js/consumer.js`)
   - –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Action Cable –∫–ª–∏–µ–Ω—Ç–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–≤—è–∑–∏
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

2. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–≥—Ä—ã** (`memgame_web/js/app.js`)
   - –§—É–Ω–∫—Ü–∏—è `subscribeToGameUpdates()` –¥–ª—è WebSocket –ø–æ–¥–ø–∏—Å–∫–∏
   - Fallback –Ω–∞ polling –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å WebSocket
   - –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `handleGameUpdate()` –¥–ª—è –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∏–≥—Ä—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `timeoutGameWait()`
2. –ï—Å–ª–∏ –≤–µ–±-—Å–æ–∫–µ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã, —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `GameChannel`
3. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ –≤ –º–æ–¥–µ–ª–∏ Game –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `broadcast_game_update`
4. –í—Å–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
5. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ `ready_to_start: true` –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
6. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å WebSocket –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ polling

## üîÄ Fallback –º–µ—Ö–∞–Ω–∏–∑–º

- **WebSocket –∞–∫—Ç–∏–≤–µ–Ω**: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTP polling
- **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚ö° **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –≤–º–µ—Å—Ç–æ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
- üìâ **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–Ω–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- üîÑ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** —Å fallback –Ω–∞ polling
- üß© **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: `rails server`
2. –û—Ç–∫—Ä–æ–π—Ç–µ `/test_websockets.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –£–∫–∞–∂–∏—Ç–µ User ID –∏ Game ID
4. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools -> Network -> WS
2. –°–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
3. –î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
4. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏

- **–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å WebSocket**: `isWebSocketsEnabled = true/false` –≤ `app.js`
- **URL WebSocket**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/cable`
- **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ

## üìù –õ–æ–≥–∏

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è:
- `üîó Connected to Action Cable`
- `üéÆ Connected to game channel`
- `üéÆ WebSocket game update received:`
- `üîÑ Falling back to polling due to WebSocket disconnect`

## üöß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å:
- `get_round_update` (–æ–∂–∏–¥–∞–Ω–∏–µ —Ä–∞—É–Ω–¥–∞)
- `get_vote_update` (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)
- `get_restart_update` (—Ä–µ—Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã)

–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å `GameChannel` –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã.

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### Redis –∞–¥–∞–ø—Ç–µ—Ä
- **–ü—Ä–æ–±–ª–µ–º–∞**: `Gem::LoadError` - –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª Redis gem
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω `gem "redis", ">= 4.0.1"` –≤ Gemfile
- **Development**: –ù–∞—Å—Ç—Ä–æ–µ–Ω `async` –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ Redis –≤ development

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ GameUser –∑–∞–ø–∏—Å–µ–π –≤ broadcasting
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω `.reload.order(:created_at)` –≤ `users_for_broadcast`

### Action Cable –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è  
- **Development**: `adapter: async` (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç Redis)
- **Production**: `adapter: redis` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)

## üìÅ –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `public/test_websockets.html` - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç–µ—Ä WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ real-time 